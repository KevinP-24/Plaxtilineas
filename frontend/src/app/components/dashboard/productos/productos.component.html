<div class="admin-content-wrapper">
  <!-- Contenido principal -->
  <main class="admin-main-content">
    <!-- Header -->
    <div class="admin-content-header">
      <div class="header-content">
        <h1 class="page-title">
          <fa-icon [icon]="faBoxes" class="title-icon"></fa-icon>
          Gestión de Productos
        </h1>
        <p class="page-subtitle">Administra el inventario completo de productos</p>
      </div>
      <button class="back-to-dashboard" (click)="volverAlDashboard()">
        <fa-icon [icon]="faArrowLeft"></fa-icon>
        <span>Volver al Dashboard</span>
      </button>
    </div>

    <!-- Card: Crear nuevo producto -->
    <section class="admin-card create-card">
      <div class="card-header">
        <h2 class="card-title">
          <fa-icon [icon]="faPlus" class="card-icon"></fa-icon>
          Crear Nuevo Producto
        </h2>
      </div>
      <div class="card-body">
        <form (ngSubmit)="crearProducto()" [formGroup]="formProducto" enctype="multipart/form-data" class="product-form">
          <div class="form-row">
            <div class="form-group">
              <label for="nombre" class="form-label">
                <fa-icon [icon]="faTag"></fa-icon>
                Nombre del producto
              </label>
              <input
                type="text"
                id="nombre"
                placeholder="Ej: Cable HDMI, Mesa de oficina..."
                formControlName="nombre"
                required
                class="form-input"
              />
              <div *ngIf="formProducto.get('nombre')?.invalid && formProducto.get('nombre')?.touched" class="error-message">
                El nombre es requerido
              </div>
            </div>

            <div class="form-group">
              <label for="precio" class="form-label">
                <fa-icon [icon]="faDollarSign"></fa-icon>
                Precio
              </label>
              <input
                type="number"
                id="precio"
                placeholder="0.00"
                formControlName="precio"
                required
                min="0"
                step="0.01"
                class="form-input"
              />
              <div *ngIf="formProducto.get('precio')?.invalid && formProducto.get('precio')?.touched" class="error-message">
                Precio válido requerido
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="subcategoria_id" class="form-label">
                <fa-icon [icon]="faFolder"></fa-icon>
                Subcategoría
              </label>
              <select
                id="subcategoria_id"
                formControlName="subcategoria_id"
                required
                class="form-select"
              >
                <option value="">Seleccione subcategoría</option>
                <option *ngFor="let sub of subcategorias" [value]="sub.id">
                  {{ sub.nombre }} ({{ sub.categoria }})
                </option>
              </select>
              <div *ngIf="formProducto.get('subcategoria_id')?.invalid && formProducto.get('subcategoria_id')?.touched" class="error-message">
                La subcategoría es requerida
              </div>
            </div>

            <div class="form-group">
              <label for="unidad" class="form-label">
                <fa-icon [icon]="faRuler"></fa-icon>
                Unidad de medida
              </label>
              <select
                id="unidad"
                formControlName="unidad"
                required
                class="form-select"
              >
                <option value="">Seleccione unidad</option>
                <option value="1">Metro</option>
                <option value="0">Unidad</option>
              </select>
              <div *ngIf="formProducto.get('unidad')?.invalid && formProducto.get('unidad')?.touched" class="error-message">
                La unidad es requerida
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="descripcion" class="form-label">
              <fa-icon [icon]="faAlignLeft"></fa-icon>
              Descripción (opcional)
            </label>
            <textarea
              id="descripcion"
              placeholder="Descripción detallada del producto..."
              formControlName="descripcion"
              class="form-textarea"
              rows="3"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="imagen" class="form-label">
              <fa-icon [icon]="faImage"></fa-icon>
              Imagen del producto
            </label>
            <div class="file-upload">
              <input
                type="file"
                id="imagen"
                (change)="onFileChange($event)"
                accept="image/*"
                class="file-input"
              />
              <label for="imagen" class="file-label">
                <fa-icon [icon]="faUpload"></fa-icon>
                Seleccionar imagen
              </label>
              <span class="file-name" *ngIf="imagenSeleccionada">
                {{ imagenSeleccionada.name }}
              </span>
              <span class="file-name" *ngIf="!imagenSeleccionada">
                No se ha seleccionado ninguna imagen
              </span>
            </div>
            <p class="form-hint">Formatos aceptados: JPG, PNG. Tamaño máximo: 5MB</p>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" [disabled]="formProducto.invalid">
              <fa-icon [icon]="faPlus"></fa-icon>
              Crear Producto
            </button>
            <button type="button" class="btn-secondary" (click)="limpiarFormulario()">
              <fa-icon [icon]="faEraser"></fa-icon>
              Limpiar
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- Card: Filtros -->
    <section class="admin-card filter-card">
      <div class="card-header">
        <h2 class="card-title">
          <fa-icon [icon]="faFilter" class="card-icon"></fa-icon>
          Filtrar Productos
        </h2>
      </div>
      <div class="card-body">
        <div class="filter-controls">
          <div class="filter-group">
            <label for="filtroSubcategoria" class="form-label">
              <fa-icon [icon]="faFolder"></fa-icon>
              Filtrar por subcategoría:
            </label>
            <select
              id="filtroSubcategoria"
              [(ngModel)]="filtroSubcategoriaId"
              (change)="filtrarPorSubcategoria()"
              class="filter-select"
            >
              <option value="">Todas las subcategorías</option>
              <option *ngFor="let sub of subcategorias" [value]="sub.id">{{ sub.nombre }}</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="searchTerm" class="form-label">
              <fa-icon [icon]="faSearch"></fa-icon>
              Buscar por nombre:
            </label>
            <div class="search-box">
              <fa-icon [icon]="faSearch" class="search-icon"></fa-icon>
              <input
                type="text"
                id="searchTerm"
                [(ngModel)]="searchTerm"
                (ngModelChange)="filtrarProductos()"
                placeholder="Buscar producto..."
                class="search-input"
              />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Card: Lista de productos -->
    <section class="admin-card list-card">
      <div class="card-header">
        <h2 class="card-title">
          <fa-icon [icon]="faList" class="card-icon"></fa-icon>
          Lista de Productos
          <span class="badge">{{ totalProductos }}</span>
        </h2>
        
        <!-- Controles de paginación superior -->
        <div class="table-controls">
          <div class="pagination-info">
            Mostrando {{ getItemsMostrados() }} de {{ totalProductos }} productos
          </div>
          <div class="results-info">
            <span class="filter-info" *ngIf="filtroSubcategoriaId">
              Filtrado por: {{ getNombreSubcategoriaFiltro() }}
            </span>
          </div>
        </div>
      </div>

      <div class="card-body">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th width="60">ID</th>
                <th width="100">Imagen</th>
                <th>Nombre</th>
                <th width="100">Precio</th>
                <th>Descripción</th>
                <th width="150">Subcategoría</th>
                <th width="100">Unidad</th>
                <th width="180">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let prod of productosPaginadas" [class.editing]="prod.editando">
                <td class="id-cell">
                  <span class="badge-id">#{{ prod.id }}</span>
                </td>

                <td>
                  <div class="image-cell">
                    <div class="image-preview">
                      <img [src]="prod.imagen_url" alt="{{ prod.nombre }}" class="product-image" />
                    </div>
                    <div *ngIf="prod.editando" class="image-upload">
                      <input
                        type="file"
                        id="imagen-{{prod.id}}"
                        (change)="seleccionarNuevaImagen($event, prod)"
                        accept="image/*"
                        class="hidden-file-input"
                      />
                      <label for="imagen-{{prod.id}}" class="upload-btn">
                        <fa-icon [icon]="faSyncAlt"></fa-icon>
                        Cambiar
                      </label>
                    </div>
                  </div>
                </td>

                <td>
                  <div class="name-cell" *ngIf="!prod.editando">
                    {{ prod.nombre }}
                  </div>
                  <input
                    *ngIf="prod.editando"
                    type="text"
                    [(ngModel)]="prod.nombre"
                    class="edit-input"
                    placeholder="Nombre del producto"
                  />
                </td>

                <td>
                  <div class="price-cell" *ngIf="!prod.editando">
                    {{ prod.precio | currency:'USD':'symbol':'1.2-2' }}
                  </div>
                  <input
                    *ngIf="prod.editando"
                    type="number"
                    [(ngModel)]="prod.precio"
                    class="edit-input"
                    min="0"
                    step="0.01"
                  />
                </td>

                <td>
                  <div class="description-cell" *ngIf="!prod.editando">
                    {{ prod.descripcion || 'Sin descripción' }}
                  </div>
                  <textarea
                    *ngIf="prod.editando"
                    [(ngModel)]="prod.descripcion"
                    class="edit-textarea"
                    placeholder="Descripción del producto"
                    rows="2"
                  ></textarea>
                </td>

                <td>
                  <div class="subcategory-cell" *ngIf="!prod.editando">
                    {{ getNombreSubcategoria(prod.subcategoria_id) }}
                  </div>
                  <select
                    *ngIf="prod.editando"
                    [(ngModel)]="prod.subcategoria_id"
                    class="edit-select"
                  >
                    <option *ngFor="let s of subcategorias" [value]="s.id">{{ s.nombre }}</option>
                  </select>
                </td>

                <td>
                  <div class="unit-cell" *ngIf="!prod.editando">
                    {{ prod.cantidad === 1 ? 'Metro' : 'Unidad' }}
                  </div>
                  <select
                    *ngIf="prod.editando"
                    [(ngModel)]="prod.cantidad"
                    class="edit-select"
                  >
                    <option value="1">Metro</option>
                    <option value="0">Unidad</option>
                  </select>
                </td>

                <td>
                  <div class="action-buttons">
                    <ng-container *ngIf="!prod.editando">
                      <button class="btn-action edit" (click)="activarEdicion(prod)" title="Editar">
                        <fa-icon [icon]="faEdit"></fa-icon>
                      </button>
                      <button class="btn-action delete" (click)="eliminarProducto(prod.id)" title="Eliminar">
                        <fa-icon [icon]="faTrashAlt"></fa-icon>
                      </button>
                    </ng-container>
                    <ng-container *ngIf="prod.editando">
                      <button class="btn-action save" (click)="actualizarProducto(prod)" title="Guardar">
                        <fa-icon [icon]="faSave"></fa-icon>
                      </button>
                      <button class="btn-action cancel" (click)="cancelarEdicion(prod)" title="Cancelar">
                        <fa-icon [icon]="faTimes"></fa-icon>
                      </button>
                    </ng-container>
                  </div>
                </td>
              </tr>
              
              <tr *ngIf="productosPaginadas.length === 0">
                <td colspan="8" class="no-data">
                  <fa-icon [icon]="faInbox" class="no-data-icon"></fa-icon>
                  <p>No se encontraron productos</p>
                  <p class="no-data-subtitle" *ngIf="filtroSubcategoriaId">
                    Intenta con otro filtro o crea un nuevo producto
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="pagination" *ngIf="totalPaginas > 1">
          <button 
            class="pagination-btn" 
            (click)="cambiarPagina(paginaActual - 1)"
            [disabled]="paginaActual === 1"
          >
            <fa-icon [icon]="faChevronLeft"></fa-icon>
          </button>
          
          <div class="pagination-numbers">
            <button
              *ngFor="let pagina of getRangoPaginas()"
              class="pagination-number"
              [class.active]="pagina === paginaActual"
              (click)="cambiarPagina(pagina)"
            >
              {{ pagina }}
            </button>
          </div>
          
          <button 
            class="pagination-btn" 
            (click)="cambiarPagina(paginaActual + 1)"
            [disabled]="paginaActual === totalPaginas"
          >
            <fa-icon [icon]="faChevronRight"></fa-icon>
          </button>
        </div>

        <!-- Selector de items por página -->
        <div class="page-size-selector">
          <label for="pageSize">
            <fa-icon [icon]="faListAlt"></fa-icon>
            Mostrar:
          </label>
          <select 
            id="pageSize" 
            [(ngModel)]="itemsPorPagina" 
            (ngModelChange)="cambiarItemsPorPagina()"
            class="page-size-select"
          >
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <span class="selector-label">productos por página</span>
        </div>
      </div>
    </section>
  </main>
</div>