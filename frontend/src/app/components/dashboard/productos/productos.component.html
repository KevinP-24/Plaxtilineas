<div class="admin-content-wrapper">
  <!-- Contenido principal -->
  <main class="admin-main-content">
    <!-- Header -->
    <div class="admin-content-header">
      <div class="header-content">
        <h1 class="page-title">
          <fa-icon [icon]="faBoxes" class="title-icon"></fa-icon>
          Gestión de Productos
        </h1>
        <p class="page-subtitle">Administra el inventario completo de productos</p>
      </div>
      <button class="back-to-dashboard" (click)="volverAlDashboard()">
        <fa-icon [icon]="faArrowLeft"></fa-icon>
        <span>Volver al Dashboard</span>
      </button>
    </div>

    <!-- Card: Crear nuevo producto -->
    <section class="admin-card create-card">
      <div class="card-header">
        <h2 class="card-title">
          <fa-icon [icon]="faPlus" class="card-icon"></fa-icon>
          Crear Nuevo Producto
        </h2>
        <button class="btn-secondary btn-sm" (click)="toggleVariantesForm()">
          <fa-icon [icon]="faLayerGroup"></fa-icon>
          {{ mostrarVariantesForm ? 'Ocultar' : 'Agregar' }} Variantes
          <span *ngIf="variantesTemporales.length > 0" class="badge">{{ variantesTemporales.length }}</span>
        </button>
      </div>
      <div class="card-body">
        <form (ngSubmit)="crearProducto()" [formGroup]="formProducto" enctype="multipart/form-data" class="product-form">
          <div class="form-row">
            <div class="form-group">
              <label for="nombre" class="form-label">
                <fa-icon [icon]="faTag"></fa-icon>
                Nombre del producto
              </label>
              <input
                type="text"
                id="nombre"
                placeholder="Ej: Cable HDMI, Mesa de oficina..."
                formControlName="nombre"
                required
                class="form-input"
              />
              <div *ngIf="formProducto.get('nombre')?.invalid && formProducto.get('nombre')?.touched" class="error-message">
                El nombre es requerido
              </div>
            </div>

            <div class="form-group">
              <label for="precio" class="form-label">
                <fa-icon [icon]="faDollarSign"></fa-icon>
                Precio Base
              </label>
              <input
                type="number"
                id="precio"
                placeholder="0.00"
                formControlName="precio"
                required
                min="0"
                step="0.01"
                class="form-input"
              />
              <div *ngIf="formProducto.get('precio')?.invalid && formProducto.get('precio')?.touched" class="error-message">
                Precio válido requerido
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="subcategoria_id" class="form-label">
                <fa-icon [icon]="faFolder"></fa-icon>
                Subcategoría
              </label>
              <select
                id="subcategoria_id"
                formControlName="subcategoria_id"
                required
                class="form-select"
              >
                <option value="">Seleccione subcategoría</option>
                <option *ngFor="let sub of subcategorias" [value]="sub.id">
                  {{ sub.nombre }} ({{ sub.categoria }})
                </option>
              </select>
              <div *ngIf="formProducto.get('subcategoria_id')?.invalid && formProducto.get('subcategoria_id')?.touched" class="error-message">
                La subcategoría es requerida
              </div>
            </div>

            <div class="form-group">
              <label for="unidad" class="form-label">
                <fa-icon [icon]="faRuler"></fa-icon>
                Unidad de medida
              </label>
              <select
                id="unidad"
                formControlName="unidad"
                required
                class="form-select"
              >
                <option value="">Seleccione unidad</option>
                <option value="unidad">Unidad (pieza)</option>
                <option value="metro">Metro (m)</option>
                <option value="metro cuadrado">Metro cuadrado (m²)</option>
                <option value="kg">Kilogramo (kg)</option>
                <option value="litro">Litro (L)</option>
                <option value="rollo">Rollo</option>
                <option value="paquete">Paquete</option>
                <option value="caja">Caja</option>
                <option value="bolsa">Bolsa</option>
                <option value="tubo">Tubo</option>
                <option value="lámina">Lámina</option>
                <option value="carrete">Carrete</option>
                <option value="galón">Galón</option>
              </select>
              <div *ngIf="formProducto.get('unidad')?.invalid && formProducto.get('unidad')?.touched" class="error-message">
                La unidad es requerida
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="descripcion" class="form-label">
              <fa-icon [icon]="faAlignLeft"></fa-icon>
              Descripción (opcional)
            </label>
            <textarea
              id="descripcion"
              placeholder="Descripción detallada del producto..."
              formControlName="descripcion"
              class="form-textarea"
              rows="3"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="imagen" class="form-label">
              <fa-icon [icon]="faImage"></fa-icon>
              Imagen del producto
            </label>
            <div class="file-upload">
              <input
                type="file"
                id="imagen"
                (change)="onFileChange($event)"
                accept="image/*"
                class="file-input"
              />
              <label for="imagen" class="file-label">
                <fa-icon [icon]="faUpload"></fa-icon>
                Seleccionar imagen
              </label>
              <span class="file-name" *ngIf="imagenSeleccionada">
                {{ imagenSeleccionada.name }}
              </span>
              <span class="file-name" *ngIf="!imagenSeleccionada">
                No se ha seleccionado ninguna imagen
              </span>
            </div>
            <p class="form-hint">Formatos aceptados: JPG, PNG. Tamaño máximo: 5MB</p>
          </div>

          <!-- Sección de Variantes (durante creación) -->
          <div *ngIf="mostrarVariantesForm" class="variantes-section">
            <div class="variantes-header">
              <h3>
                <fa-icon [icon]="faLayerGroup"></fa-icon>
                Variantes del Producto
                <span class="variantes-count">({{ variantesTemporales.length }})</span>
              </h3>
              <p class="variantes-subtitle">Agrega diferentes versiones o presentaciones del producto</p>
            </div>

            <div class="variantes-form">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Nombre de la variante</label>
                  <input
                    type="text"
                    [(ngModel)]="varianteTemporal.nombre"
                    placeholder="Ej: Color rojo, Talla M, Pack de 3..."
                    class="form-input"
                    [ngModelOptions]="{standalone: true}"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Precio</label>
                  <input
                    type="number"
                    [(ngModel)]="varianteTemporal.precio"
                    placeholder="0.00"
                    min="0"
                    step="0.01"
                    class="form-input"
                    [ngModelOptions]="{standalone: true}"
                  />
                </div>
                <div class="form-group">
                  <button type="button" class="btn-primary" (click)="agregarVarianteTemporal()">
                    <fa-icon [icon]="faPlus"></fa-icon>
                    Agregar Variante
                  </button>
                </div>
              </div>
            </div>

            <!-- Lista de variantes temporales -->
            <div *ngIf="variantesTemporales.length > 0" class="variantes-list">
              <div class="variantes-table">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Precio</th>
                      <th width="80">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let variante of variantesTemporales; let i = index">
                      <td>{{ variante.nombre }}</td>
                      <td>{{ variante.precio | currency:'USD':'symbol':'1.2-2' }}</td>
                      <td>
                        <button type="button" class="btn-action delete" (click)="eliminarVarianteTemporal(i)">
                          <fa-icon [icon]="faMinus"></fa-icon>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" [disabled]="formProducto.invalid">
              <fa-icon [icon]="faPlus"></fa-icon>
              Crear Producto {{ variantesTemporales.length > 0 ? 'con Variantes' : '' }}
            </button>
            <button type="button" class="btn-secondary" (click)="limpiarFormulario()">
              <fa-icon [icon]="faEraser"></fa-icon>
              Limpiar
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- Card: Filtros -->
    <section class="admin-card filter-card">
      <div class="card-header">
        <h2 class="card-title">
          <fa-icon [icon]="faFilter" class="card-icon"></fa-icon>
          Filtrar Productos
        </h2>
      </div>
      <div class="card-body">
        <div class="filter-controls">
          <div class="filter-group">
            <label for="filtroSubcategoria" class="form-label">
              <fa-icon [icon]="faFolder"></fa-icon>
              Filtrar por subcategoría:
            </label>
            <select
              id="filtroSubcategoria"
              [(ngModel)]="filtroSubcategoriaId"
              (change)="filtrarPorSubcategoria()"
              class="filter-select"
            >
              <option value="">Todas las subcategorías</option>
              <option *ngFor="let sub of subcategorias" [value]="sub.id">{{ sub.nombre }}</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="searchTerm" class="form-label">
              <fa-icon [icon]="faSearch"></fa-icon>
              Buscar por nombre:
            </label>
            <div class="search-box">
              <fa-icon [icon]="faSearch" class="search-icon"></fa-icon>
              <input
                type="text"
                id="searchTerm"
                [(ngModel)]="searchTerm"
                (ngModelChange)="filtrarProductos()"
                placeholder="Buscar producto..."
                class="search-input"
              />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Card: Lista de productos -->
    <section class="admin-card list-card">
      <div class="card-header">
        <h2 class="card-title">
          <fa-icon [icon]="faList" class="card-icon"></fa-icon>
          Lista de Productos
          <span class="badge">{{ totalProductos }}</span>
        </h2>
        
        <!-- Controles de paginación superior -->
        <div class="table-controls">
          <div class="pagination-info">
            Mostrando {{ getItemsMostrados() }} de {{ totalProductos }} productos
          </div>
          <div class="results-info">
            <span class="filter-info" *ngIf="filtroSubcategoriaId">
              Filtrado por: {{ getNombreSubcategoriaFiltro() }}
            </span>
          </div>
        </div>
      </div>

      <div class="card-body">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th width="60">ID</th>
                <th width="100">Imagen</th>
                <th>Nombre</th>
                <th width="100">Precio</th>
                <th>Descripción</th>
                <th width="150">Subcategoría</th>
                <th width="100">Unidad</th>
                <th width="180">Acciones</th>
              </tr>
            </thead>
            <!-- Reemplaza desde la línea 469 hasta el final de la tabla con esto: -->

<tbody>
  <ng-container *ngFor="let prod of productosPaginadas; let i = index">
    <!-- Fila del producto -->
    <tr [class.editing]="prod.editando">
      <td class="id-cell">
        <span class="badge-id">#{{ prod.id }}</span>
        <button 
          class="toggle-variantes" 
          (click)="toggleVariantesProducto(prod.id)"
          [title]="productoMostrandoVariantes === prod.id ? 'Ocultar variantes' : 'Ver variantes'"
        >
          <fa-icon [icon]="productoMostrandoVariantes === prod.id ? faCaretUp : faCaretDown"></fa-icon>
        </button>
      </td>

      <td>
        <div class="image-cell">
          <div class="image-preview">
            <img [src]="prod.imagen_url" alt="{{ prod.nombre }}" class="product-image" />
          </div>
          <div *ngIf="prod.editando" class="image-upload">
            <input
              type="file"
              id="imagen-{{prod.id}}"
              (change)="seleccionarNuevaImagen($event, prod)"
              accept="image/*"
              class="hidden-file-input"
            />
            <label for="imagen-{{prod.id}}" class="upload-btn">
              <fa-icon [icon]="faSyncAlt"></fa-icon>
              Cambiar
            </label>
          </div>
        </div>
      </td>

      <td>
        <div class="name-cell" *ngIf="!prod.editando">
          {{ prod.nombre }}
        </div>
        <input
          *ngIf="prod.editando"
          type="text"
          [(ngModel)]="prod.nombre"
          class="edit-input"
          placeholder="Nombre del producto"
        />
      </td>

      <td>
        <div class="price-cell" *ngIf="!prod.editando">
          {{ prod.precio | currency:'USD':'symbol':'1.2-2' }}
        </div>
        <input
          *ngIf="prod.editando"
          type="number"
          [(ngModel)]="prod.precio"
          class="edit-input"
          min="0"
          step="0.01"
        />
      </td>

      <td>
        <div class="description-cell" *ngIf="!prod.editando">
          {{ prod.descripcion || 'Sin descripción' }}
        </div>
        <textarea
          *ngIf="prod.editando"
          [(ngModel)]="prod.descripcion"
          class="edit-textarea"
          placeholder="Descripción del producto"
          rows="2"
        ></textarea>
      </td>

      <td>
        <div class="subcategory-cell" *ngIf="!prod.editando">
          {{ prod.subcategoria }}
        </div>
        <select
          *ngIf="prod.editando"
          [(ngModel)]="prod.subcategoria_id"
          class="edit-select"
        >
          <option *ngFor="let s of subcategorias" [value]="s.id">{{ s.nombre }}</option>
        </select>
      </td>

      <td>
        <div class="unit-cell" *ngIf="!prod.editando">
          {{ prod.unidad || 'unidad' }}
        </div>
        <select
          *ngIf="prod.editando"
          [(ngModel)]="prod.unidad"
          class="edit-select"
        >
          <option value="unidad">Unidad (pieza)</option>
          <option value="metro">Metro (m)</option>
          <option value="metro cuadrado">Metro cuadrado (m²)</option>
          <option value="kg">Kilogramo (kg)</option>
          <option value="litro">Litro (L)</option>
          <option value="rollo">Rollo</option>
          <option value="paquete">Paquete</option>
          <option value="caja">Caja</option>
          <option value="bolsa">Bolsa</option>
          <option value="tubo">Tubo</option>
          <option value="lámina">Lámina</option>
          <option value="carrete">Carrete</option>
          <option value="galón">Galón</option>
        </select>
      </td>

      <td>
        <div class="action-buttons">
          <ng-container *ngIf="!prod.editando">
            <button class="btn-action edit" (click)="activarEdicion(prod)" title="Editar">
              <fa-icon [icon]="faEdit"></fa-icon>
            </button>
            <button class="btn-action delete" (click)="eliminarProducto(prod.id)" title="Eliminar">
              <fa-icon [icon]="faTrashAlt"></fa-icon>
            </button>
          </ng-container>
          <ng-container *ngIf="prod.editando">
            <button class="btn-action save" (click)="actualizarProducto(prod)" title="Guardar">
              <fa-icon [icon]="faSave"></fa-icon>
            </button>
            <button class="btn-action cancel" (click)="cancelarEdicion(prod)" title="Cancelar">
              <fa-icon [icon]="faTimes"></fa-icon>
            </button>
          </ng-container>
        </div>
      </td>
    </tr>
    
    <!-- Fila expandida para variantes (solo si este producto está expandido) -->
    <tr *ngIf="productoMostrandoVariantes === prod.id" class="variantes-expanded-row">
      <td colspan="8">
        <div class="variantes-container">
          <div *ngIf="variantesProductos[productoMostrandoVariantes!]">
            <div class="variantes-header">
              <h4>
                <fa-icon [icon]="faLayerGroup"></fa-icon>
                Variantes del Producto #{{productoMostrandoVariantes}}
                <span class="variantes-count">({{ variantesProductos[productoMostrandoVariantes!].length }})</span>
              </h4>
            </div>
            
            <!-- Formulario para agregar nueva variante -->
            <div class="variantes-form nueva-variante-form">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Nueva Variante</label>
                  <input
                    type="text"
                    [(ngModel)]="nuevaVarianteProducto[productoMostrandoVariantes!].nombre"
                    placeholder="Ej: Color azul, Talla L..."
                    class="form-input"
                    [ngModelOptions]="{standalone: true}"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Precio</label>
                  <input
                    type="number"
                    [(ngModel)]="nuevaVarianteProducto[productoMostrandoVariantes!].precio"
                    placeholder="0.00"
                    min="0"
                    step="0.01"
                    class="form-input"
                    [ngModelOptions]="{standalone: true}"
                  />
                </div>
                <div class="form-group">
                  <button type="button" class="btn-primary" 
                          (click)="crearVarianteEnTabla(productoMostrandoVariantes!)">
                    <fa-icon [icon]="faPlus"></fa-icon>
                    Agregar Variante
                  </button>
                </div>
              </div>
            </div>

            <!-- Lista de variantes existentes -->
            <div *ngIf="variantesProductos[productoMostrandoVariantes!].length > 0" 
                 class="variantes-list-existing">
              <table class="data-table variantes-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Creado</th>
                    <th width="150">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let variante of variantesProductos[productoMostrandoVariantes!]; 
                               trackBy: trackByVarianteId"
                      [class.editing]="variante.editando">
                    <td>#{{ variante.id }}</td>
                    
                    <!-- Nombre (editable) -->
                    <td>
                      <div *ngIf="!variante.editando" class="variante-nombre">
                        {{ variante.nombre }}
                      </div>
                      <input
                        *ngIf="variante.editando"
                        type="text"
                        [(ngModel)]="variante.nombre"
                        class="edit-input variante-edit-input"
                        placeholder="Nombre de la variante"
                      />
                    </td>
                    
                    <!-- Precio (editable) -->
                    <td>
                      <div *ngIf="!variante.editando" class="variante-precio">
                        {{ variante.precio | currency:'USD':'symbol':'1.2-2' }}
                      </div>
                      <input
                        *ngIf="variante.editando"
                        type="number"
                        [(ngModel)]="variante.precio"
                        class="edit-input variante-edit-input"
                        min="0"
                        step="0.01"
                        placeholder="0.00"
                      />
                    </td>
                    
                    <td>
                      <div class="variante-fecha">
                        {{ variante.creado_en | date:'short' }}
                      </div>
                    </td>
                    
                    <!-- Acciones para variantes -->
                    <td>
                      <div class="action-buttons variante-actions">
                        <ng-container *ngIf="!variante.editando">
                          <button class="btn-action edit" 
                                  (click)="activarEdicionVariante(productoMostrandoVariantes!, variante)" 
                                  title="Editar variante">
                            <fa-icon [icon]="faPen"></fa-icon>
                          </button>
                          <button class="btn-action delete" 
                                  (click)="eliminarVariante(productoMostrandoVariantes!, variante.id)" 
                                  title="Eliminar variante">
                            <fa-icon [icon]="faTrashAlt"></fa-icon>
                          </button>
                        </ng-container>
                        <ng-container *ngIf="variante.editando">
                          <button class="btn-action save" 
                                  (click)="guardarEdicionVariante(productoMostrandoVariantes!, variante)" 
                                  title="Guardar cambios">
                            <fa-icon [icon]="faCheck"></fa-icon>
                          </button>
                          <button class="btn-action cancel" 
                                  (click)="cancelarEdicionVariante(variante)" 
                                  title="Cancelar edición">
                            <fa-icon [icon]="faXmark"></fa-icon>
                          </button>
                        </ng-container>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div *ngIf="variantesProductos[productoMostrandoVariantes!].length === 0" class="no-variantes">
              <div class="no-variantes-content">
                <fa-icon [icon]="faInbox" class="no-data-icon"></fa-icon>
                <p>Este producto no tiene variantes</p>
                <p class="no-variantes-subtitle">Usa el formulario arriba para agregar la primera variante</p>
              </div>
            </div>
          </div>
          
          <div *ngIf="!variantesProductos[productoMostrandoVariantes!]" class="loading-variantes">
            <div class="loading-spinner"></div>
            <p>Cargando variantes...</p>
          </div>
        </div>
      </td>
    </tr>
  </ng-container>
  
  <!-- Mensaje cuando no hay productos -->
  <tr *ngIf="productosPaginadas.length === 0">
    <td colspan="8" class="no-data">
      <fa-icon [icon]="faInbox" class="no-data-icon"></fa-icon>
      <p>No se encontraron productos</p>
      <p class="no-data-subtitle" *ngIf="filtroSubcategoriaId">
        Intenta con otro filtro o crea un nuevo producto
      </p>
    </td>
  </tr>
</tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="pagination" *ngIf="totalPaginas > 1">
          <button 
            class="pagination-btn" 
            (click)="cambiarPagina(paginaActual - 1)"
            [disabled]="paginaActual === 1"
          >
            <fa-icon [icon]="faChevronLeft"></fa-icon>
          </button>
          
          <div class="pagination-numbers">
            <button
              *ngFor="let pagina of getRangoPaginas()"
              class="pagination-number"
              [class.active]="pagina === paginaActual"
              (click)="cambiarPagina(pagina)"
            >
              {{ pagina }}
            </button>
          </div>
          
          <button 
            class="pagination-btn" 
            (click)="cambiarPagina(paginaActual + 1)"
            [disabled]="paginaActual === totalPaginas"
          >
            <fa-icon [icon]="faChevronRight"></fa-icon>
          </button>
        </div>

        <!-- Selector de items por página -->
        <div class="page-size-selector">
          <label for="pageSize">
            <fa-icon [icon]="faListAlt"></fa-icon>
            Mostrar:
          </label>
          <select 
            id="pageSize" 
            [(ngModel)]="itemsPorPagina" 
            (ngModelChange)="cambiarItemsPorPagina()"
            class="page-size-select"
          >
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <span class="selector-label">productos por página</span>
        </div>
      </div>
    </section>
  </main>
</div>